# Queue System 打包说明

本文档说明如何将 Queue System 打包成可执行文件。

## 前置要求

1. **Node.js**: 需要安装 Node.js (推荐 v16 或更高版本)
2. **依赖安装**: 确保所有依赖已安装
   ```bash
   npm install
   cd queueSystem-client && npm install
   cd ../queueSystem-server && npm install
   ```

## 快速开始

### 基本打包（Windows x64）

在项目根目录运行：

```bash
npm run build
```

这将：
1. 构建前端 Vue 应用
2. 将前端资源复制到服务器 public 目录
3. **将数据库文件打包到可执行文件中**（如果存在）
4. 使用 pkg 将 Node.js 应用打包成可执行文件
5. 创建必要的配置目录和说明文件

**重要提示：**
- 如果 `queueSystem-server/database.sqlite` 存在，它会被打包到可执行文件中
- 建议在打包前先运行一次服务器以初始化数据库（包含初始数据和表结构）
- 打包的数据库文件作为模板，首次运行时会自动复制到可执行文件同目录下

打包完成后，可执行文件位于 `dist/queue-system.exe`

### 指定平台打包

```bash
# Windows x64 (默认)
node build-scripts/build.js --target=win-x64 --node=node18

# Linux x64
node build-scripts/build.js --target=linux-x64 --node=node18

# macOS x64
node build-scripts/build.js --target=macos-x64 --node=node18

# macOS ARM64 (Apple Silicon)
node build-scripts/build.js --target=macos-arm64 --node=node18
```

## 打包输出结构

打包完成后，`dist/` 目录结构如下：

```
dist/
├── queue-system.exe          # 可执行文件（Windows）
├── 使用说明.txt              # 使用说明文档
├── 数据库说明.txt            # 数据库文件说明
└── pic/                      # 外部图片目录
    ├── README.txt            # 图片自定义说明
    └── (自定义图片文件)
```

## 打包配置

打包配置位于 `queueSystem-server/package.json` 的 `pkg` 字段中：

```json
{
  "pkg": {
    "assets": [
      "public/**/*",
      "generated-models-auto/**/*",
      "models/**/*"
    ],
    "scripts": [
      "controllers/**/*.js",
      "routes/**/*.js",
      "services/**/*.js",
      "utils/**/*.js",
      "websocket/**/*.js"
    ],
    "targets": [
      "node16-win-x64",
      "node18-win-x64",
      "node20-win-x64"
    ]
  }
}
```

### 配置说明

- **assets**: 需要打包到可执行文件中的静态资源
- **scripts**: 需要包含的 JavaScript 文件
- **targets**: 支持的目标平台（可在命令行覆盖）

## 常见问题

### 1. 原生模块问题

如果遇到 `better-sqlite3` 或 `sqlite3` 等原生模块的打包问题：

**解决方案：**
```bash
# 重新构建原生模块
cd queueSystem-server
npm rebuild better-sqlite3

# 确保 better-sqlite3 已正确安装
npm install better-sqlite3 --save

# 然后重新打包
cd ..
npm run build
```

**注意：** 程序已配置为使用 `better-sqlite3` 而不是 `sqlite3`，因为 `better-sqlite3` 对 pkg 打包支持更好。如果仍然遇到问题，请确保：
1. `better-sqlite3` 已正确安装
2. 在打包前运行 `npm rebuild better-sqlite3`
3. 使用与目标平台匹配的 Node.js 版本进行打包

### 2. 文件大小过大

可执行文件可能较大（通常 50-100MB），这是正常的，因为包含了：
- Node.js 运行时
- 所有依赖模块
- 前端静态资源

### 3. 数据库文件位置

数据库文件 (`database.sqlite`) **会**被打包进可执行文件中作为初始模板。

**工作原理：**
- 打包时：如果 `queueSystem-server/database.sqlite` 存在，会被包含在可执行文件中
- 首次运行：程序会自动检测可执行文件目录下是否有 `database.sqlite`
  - 如果不存在：从打包资源中复制初始数据库文件到可执行文件同目录
  - 如果已存在：使用现有的数据库文件（保留用户数据）
- 实际数据：所有业务数据存储在可执行文件同目录下的 `database.sqlite` 中

**建议：**
- 打包前先运行服务器初始化数据库，确保包含完整的表结构和初始数据
- 定期备份可执行文件目录下的 `database.sqlite` 文件

### 4. 端口配置

默认端口为 3000，可通过环境变量修改：

**Windows:**
```cmd
set PORT=8080
queue-system.exe
```

**Linux/macOS:**
```bash
PORT=8080 ./queue-system
```

### 5. 跨平台打包

pkg 支持跨平台打包，但需要注意：
- 在 Windows 上可以打包 Linux/macOS 版本
- 在 Linux 上可以打包 Windows/macOS 版本
- 在 macOS 上可以打包 Windows/Linux 版本

但某些原生模块可能需要目标平台的二进制文件。

## 高级用法

### 自定义输出路径

修改 `build-scripts/build.js` 中的输出路径，或使用 pkg 的 `--output` 参数。

### 包含额外资源

在 `queueSystem-server/package.json` 的 `pkg.assets` 中添加需要包含的文件路径。

**数据库文件：**
- 数据库文件已默认包含在 `pkg.assets` 中
- 确保打包前 `queueSystem-server/database.sqlite` 存在且包含所需数据
- 如果数据库文件不存在，程序会在首次运行时创建空数据库

### 排除文件

某些文件（如 `node_modules`、`.git`）会自动排除，无需手动配置。

## 部署建议

1. **测试**: 打包后先在目标环境测试可执行文件
2. **数据库备份**: 定期备份 `database.sqlite` 文件
3. **日志**: 考虑添加日志文件输出，便于排查问题
4. **服务化**: 在生产环境，建议使用 PM2 或 Windows Service 管理进程

## 相关文档

- [使用说明](../dist/使用说明.txt) - 应用使用说明
- [数据库说明](../dist/数据库说明.txt) - 数据库文件说明
- [图片自定义说明](../dist/pic/README.txt) - 图片自定义说明

## 技术支持

如遇到打包问题，请检查：
1. Node.js 版本是否兼容
2. 所有依赖是否正确安装
3. 原生模块是否正确构建
4. 查看 pkg 官方文档: https://github.com/vercel/pkg

