# Queue System 打包步骤

本文档提供详细的打包步骤，帮助您将 Queue System 打包成可执行文件。

## 📋 目录

1. [前置准备](#前置准备)
2. [初始化数据库（推荐）](#初始化数据库推荐)
3. [执行打包](#执行打包)
4. [验证打包结果](#验证打包结果)
5. [常见问题处理](#常见问题处理)

---

## 前置准备

### 步骤 1: 检查 Node.js 版本

确保已安装 Node.js v16 或更高版本：

```bash
node --version
# 应该显示 v16.x.x 或更高版本
```

### 步骤 2: 安装项目依赖

在项目根目录执行：

```bash
# 安装根目录依赖
npm install

# 安装前端依赖
cd queueSystem-client
npm install

# 安装后端依赖
cd ../queueSystem-server
npm install

# 返回项目根目录
cd ..
```

### 步骤 3: 验证依赖安装

确保所有依赖都已正确安装，没有错误信息。

---

## 初始化数据库（推荐）

**为什么需要初始化数据库？**

打包的数据库文件会作为初始模板，包含：
- 完整的数据库表结构
- 初始业务类型数据
- 管理员账户设置
- 其他初始化数据

### 步骤 1: 启动服务器

```bash
# 在项目根目录
npm start
```

或者：

```bash
cd queueSystem-server
npm start
```

### 步骤 2: 等待数据库初始化

服务器启动后，会看到类似以下输出：

```
数据库初始化成功
服务器运行在 http://0.0.0.0:3000
```

### 步骤 3: 验证数据库文件

检查 `queueSystem-server` 目录下是否生成了 `database.sqlite` 文件：

```bash
# Windows
dir queueSystem-server\database.sqlite

# Linux/macOS
ls -lh queueSystem-server/database.sqlite
```

### 步骤 4: 停止服务器

按 `Ctrl + C` 停止服务器。

**注意：** 如果数据库文件已存在且包含数据，可以跳过此步骤，直接使用现有数据库进行打包。

---

## 执行打包

### 方法一：使用默认命令（推荐）

在项目根目录执行：

```bash
npm run build
```

这将：
1. ✅ 构建前端 Vue 应用
2. ✅ 复制前端资源到服务器 public 目录
3. ✅ 检查并打包数据库文件
4. ✅ 使用 pkg 打包成可执行文件
5. ✅ 创建必要的配置目录和说明文件

### 方法二：指定平台打包

```bash
# Windows x64
npm run build:win

# Linux x64
npm run build:linux

# macOS Intel
npm run build:mac

# macOS Apple Silicon (M1/M2)
npm run build:mac-arm
```

### 方法三：自定义参数

```bash
# 指定平台和 Node.js 版本
node build-scripts/build.js --target=win-x64 --node=node18
```

**支持的平台：**
- `win-x64` - Windows 64位
- `linux-x64` - Linux 64位
- `macos-x64` - macOS Intel
- `macos-arm64` - macOS Apple Silicon

**支持的 Node.js 版本：**
- `node16` - Node.js v16
- `node18` - Node.js v18（推荐）
- `node20` - Node.js v20

### 打包过程说明

打包过程中会显示以下步骤：

```
========================================
开始构建 Queue System 可执行文件...
========================================

步骤 1/5: 构建前端应用...
✓ 前端构建完成

步骤 2/5: 准备服务器目录和数据库文件...
✓ 找到数据库文件: X.XX MB
  数据库文件将被打包到可执行文件中

步骤 3/5: 复制前端资源到服务器...
✓ 前端资源复制完成

步骤 4/5: 打包服务器应用为可执行文件...
  目标平台: node18-win-x64
  输出文件: dist/queue-system.exe
✓ 可执行文件打包完成

步骤 5/5: 创建外部资源目录...
✓ 已复制默认图片到外部目录
✓ 外部资源目录创建完成

========================================
✓ 打包完成！
========================================

可执行文件位置: dist/queue-system.exe
外部图片目录: dist/pic/
数据库文件: 已包含在可执行文件中，首次运行时会自动复制到可执行文件同目录

使用说明: 请查看 dist/使用说明.txt
```

---

## 验证打包结果

### 步骤 1: 检查输出目录

打包完成后，检查 `dist/` 目录：

```bash
# Windows
dir dist

# Linux/macOS
ls -lh dist
```

应该看到：
```
dist/
├── queue-system.exe          # 可执行文件（Windows）
├── 使用说明.txt              # 使用说明
├── 数据库说明.txt            # 数据库说明
└── pic/                      # 图片目录
    └── README.txt            # 图片说明
```

### 步骤 2: 测试可执行文件

**Windows:**
```cmd
cd dist
queue-system.exe
```

**Linux/macOS:**
```bash
cd dist
chmod +x queue-system
./queue-system
```

### 步骤 3: 验证服务启动

打开浏览器访问：
- 取票页面: http://localhost:3000/ticket
- 显示屏: http://localhost:3000/display
- 叫号机: http://localhost:3000/counter
- 管理员: http://localhost:3000/admin

如果页面正常显示，说明打包成功！

### 步骤 4: 检查数据库文件

首次运行后，检查可执行文件同目录下是否生成了 `database.sqlite`：

```bash
# Windows
dir database.sqlite

# Linux/macOS
ls -lh database.sqlite
```

---

## 常见问题处理

### 问题 1: 前端构建失败

**错误信息：**
```
✗ 前端构建失败: ...
```

**解决方案：**
```bash
# 清理并重新安装前端依赖
cd queueSystem-client
rm -rf node_modules package-lock.json
npm install
cd ..
npm run build
```

### 问题 2: 原生模块打包失败

**错误信息：**
```
Error: Cannot find module 'better-sqlite3'
```

**解决方案：**
```bash
# 重新构建原生模块
cd queueSystem-server
npm rebuild better-sqlite3 sqlite3

# 返回根目录重新打包
cd ..
npm run build
```

### 问题 3: 数据库文件未找到

**警告信息：**
```
⚠ 警告: 数据库文件不存在，将创建空数据库
```

**解决方案：**
1. 按照 [初始化数据库](#初始化数据库推荐) 步骤创建数据库
2. 或者直接打包，程序会在首次运行时创建空数据库

### 问题 4: 打包文件过大

可执行文件通常为 50-100MB，这是正常的，因为包含：
- Node.js 运行时
- 所有依赖模块
- 前端静态资源
- 数据库文件

### 问题 5: 端口被占用

**错误信息：**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方案：**

**方法一：** 修改端口
```bash
# Windows
set PORT=8080
queue-system.exe

# Linux/macOS
PORT=8080 ./queue-system
```

**方法二：** 关闭占用端口的程序
```bash
# Windows - 查找占用端口的进程
netstat -ano | findstr :3000

# Linux/macOS - 查找占用端口的进程
lsof -i :3000
```

### 问题 6: 跨平台打包失败

某些原生模块（如 `better-sqlite3`）可能需要目标平台的二进制文件。

**解决方案：**
- 在目标平台上直接打包
- 或使用 Docker 容器在目标平台上打包

---

## 打包检查清单

打包前确认：

- [ ] Node.js 版本 >= v16
- [ ] 所有依赖已安装（根目录、前端、后端）
- [ ] 数据库文件已初始化（推荐）
- [ ] 端口 3000 未被占用（或准备修改端口）

打包后验证：

- [ ] `dist/` 目录存在且包含可执行文件
- [ ] 可执行文件可以正常启动
- [ ] 浏览器可以访问应用页面
- [ ] 数据库文件在首次运行后正确创建

---

## 快速参考

### 完整打包流程（一行命令）

```bash
# 1. 安装依赖（首次）
npm install && cd queueSystem-client && npm install && cd ../queueSystem-server && npm install && cd ..

# 2. 初始化数据库（推荐）
npm start
# 等待初始化完成，按 Ctrl+C 停止

# 3. 打包
npm run build

# 4. 测试
cd dist && queue-system.exe
```

### 常用打包命令

```bash
# 默认打包（Windows）
npm run build

# 指定平台
npm run build:win      # Windows
npm run build:linux    # Linux
npm run build:mac      # macOS Intel
npm run build:mac-arm  # macOS Apple Silicon
```

---

## 下一步

打包完成后，您可以：

1. **部署应用** - 将 `dist/` 目录复制到目标服务器
2. **自定义配置** - 修改 `pic/` 目录中的图片
3. **备份数据** - 定期备份 `database.sqlite` 文件
4. **查看文档** - 阅读 `dist/使用说明.txt`

---

## 需要帮助？

如果遇到问题，请检查：

1. [打包说明.md](./打包说明.md) - 详细配置说明
2. [使用说明.txt](../dist/使用说明.txt) - 应用使用说明
3. pkg 官方文档: https://github.com/vercel/pkg

