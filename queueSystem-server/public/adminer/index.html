<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQLite 数据库管理工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .tables {
      float: left;
      width: 20%;
      padding-right: 20px;
      border-right: 1px solid #eee;
    }
    .content {
      float: left;
      width: 75%;
      padding-left: 20px;
    }
    .table-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .table-list li {
      padding: 8px 5px;
      cursor: pointer;
      border-bottom: 1px solid #f5f5f5;
    }
    .table-list li:hover {
      background-color: #f5f5f5;
    }
    .table-list li.active {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
    .query-box {
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-family: monospace;
    }
    .btn {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .clearfix:after {
      content: "";
      display: table;
      clear: both;
    }
    .schema-table {
      margin-bottom: 20px;
    }
    .pagination {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SQLite 数据库管理工具</h1>
    
    <div class="clearfix">
      <div class="tables">
        <h2>数据表</h2>
        <ul id="table-list" class="table-list"></ul>
      </div>
      
      <div class="content">
        <div class="query-box">
          <h2>SQL 查询</h2>
          <textarea id="sql-query" placeholder="输入SQL查询语句..."></textarea>
          <button id="execute-btn" class="btn">执行</button>
          <div id="error" class="error"></div>
        </div>
        
        <div id="schema-container" style="display: none;">
          <h3>表结构</h3>
          <table id="schema-table" class="schema-table">
            <thead>
              <tr>
                <th>列名</th>
                <th>类型</th>
                <th>非空</th>
                <th>默认值</th>
                <th>主键</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div id="data-container">
          <h3 id="data-title"></h3>
          <table id="data-table">
            <thead></thead>
            <tbody></tbody>
          </table>
          <div id="pagination" class="pagination"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // 当页面加载完成时获取所有表
    document.addEventListener('DOMContentLoaded', function() {
      loadTables();
      
      // 添加执行SQL按钮事件
      document.getElementById('execute-btn').addEventListener('click', executeQuery);
    });
    
    // 加载数据库表
    function loadTables() {
      fetch('/api/admin/tables')
        .then(response => response.json())
        .then(tables => {
          const tableList = document.getElementById('table-list');
          tableList.innerHTML = '';
          
          tables.forEach(table => {
            const li = document.createElement('li');
            li.textContent = table.name;
            li.addEventListener('click', () => selectTable(table.name));
            tableList.appendChild(li);
          });
        })
        .catch(error => {
          console.error('获取表失败:', error);
          document.getElementById('error').textContent = '获取表失败: ' + error.message;
        });
    }
    
    // 选择表
    function selectTable(tableName, page = 1) {
      // 突出显示选中的表
      const tableItems = document.querySelectorAll('#table-list li');
      tableItems.forEach(item => {
        if (item.textContent === tableName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      
      // 加载表结构
      fetch(`/api/admin/tables/${tableName}/schema`)
        .then(response => response.json())
        .then(schema => {
          const schemaTable = document.getElementById('schema-table').querySelector('tbody');
          schemaTable.innerHTML = '';
          
          schema.forEach(column => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${column.name}</td>
              <td>${column.type}</td>
              <td>${column.notnull ? '是' : '否'}</td>
              <td>${column.dflt_value || ''}</td>
              <td>${column.pk ? '是' : '否'}</td>
            `;
            schemaTable.appendChild(tr);
          });
          
          document.getElementById('schema-container').style.display = 'block';
        })
        .catch(error => {
          console.error('获取表结构失败:', error);
          document.getElementById('error').textContent = '获取表结构失败: ' + error.message;
        });
      
      // 加载表数据
      fetch(`/api/admin/tables/${tableName}/data?page=${page}&limit=20`)
        .then(response => response.json())
        .then(result => {
          const dataTable = document.getElementById('data-table');
          document.getElementById('data-title').textContent = `${tableName} 数据`;
          
          // 设置表头
          const thead = dataTable.querySelector('thead');
          const tbody = dataTable.querySelector('tbody');
          thead.innerHTML = '';
          tbody.innerHTML = '';
          
          if (result.data.length > 0) {
            const headerRow = document.createElement('tr');
            Object.keys(result.data[0]).forEach(key => {
              const th = document.createElement('th');
              th.textContent = key;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // 填充数据行
            result.data.forEach(row => {
              const tr = document.createElement('tr');
              Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value !== null ? value : 'NULL';
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
            
            // 设置分页
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(result.total / result.limit);
            
            let paginationHTML = '';
            if (totalPages > 1) {
              paginationHTML = '页码: ';
              
              if (page > 1) {
                paginationHTML += `<a href="#" onclick="selectTable('${tableName}', ${page - 1})">上一页</a> `;
              }
              
              for (let i = 1; i <= totalPages; i++) {
                if (i === page) {
                  paginationHTML += `<strong>${i}</strong> `;
                } else {
                  paginationHTML += `<a href="#" onclick="selectTable('${tableName}', ${i})">${i}</a> `;
                }
              }
              
              if (page < totalPages) {
                paginationHTML += `<a href="#" onclick="selectTable('${tableName}', ${page + 1})">下一页</a>`;
              }
            }
            
            paginationDiv.innerHTML = paginationHTML;
          } else {
            tbody.innerHTML = '<tr><td colspan="100%">没有数据</td></tr>';
          }
        })
        .catch(error => {
          console.error('获取表数据失败:', error);
          document.getElementById('error').textContent = '获取表数据失败: ' + error.message;
        });
    }
    
    // 执行SQL查询
    function executeQuery() {
      const sql = document.getElementById('sql-query').value.trim();
      
      if (!sql) {
        document.getElementById('error').textContent = '请输入SQL查询';
        return;
      }
      
      fetch('/api/admin/query', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ sql })
      })
        .then(response => response.json())
        .then(result => {
          document.getElementById('error').textContent = '';
          document.getElementById('data-title').textContent = 'SQL查询结果';
          
          const dataTable = document.getElementById('data-table');
          const thead = dataTable.querySelector('thead');
          const tbody = dataTable.querySelector('tbody');
          thead.innerHTML = '';
          tbody.innerHTML = '';
          
          if (Array.isArray(result) && result.length > 0) {
            // 显示SELECT查询结果
            const headerRow = document.createElement('tr');
            Object.keys(result[0]).forEach(key => {
              const th = document.createElement('th');
              th.textContent = key;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            result.forEach(row => {
              const tr = document.createElement('tr');
              Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value !== null ? value : 'NULL';
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
          } else if (typeof result === 'object') {
            // 显示INSERT/UPDATE/DELETE结果
            const tr = document.createElement('tr');
            tbody.innerHTML = `
              <tr>
                <th>操作结果</th>
                <td>
                  ${JSON.stringify(result)}
                </td>
              </tr>
            `;
          }
          
          document.getElementById('pagination').innerHTML = '';
          document.getElementById('schema-container').style.display = 'none';
        })
        .catch(error => {
          console.error('执行SQL查询失败:', error);
          document.getElementById('error').textContent = '执行SQL查询失败: ' + error.message;
        });
    }
  </script>
</body>
</html>
